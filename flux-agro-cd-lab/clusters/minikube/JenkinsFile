pipeline {
    environment {
        DOCKER_HOST = 'tcp://host.docker.internal:2375'
    }
    agent {
        docker {
            image 'radeczu/node-with-jq'
            args '--add-host=host.docker.internal:host-gateway -e DOCKER_HOST=tcp://host.docker.internal:2375'
        }
    }
    triggers {
      pollSCM '*/5 * * * *'
    }
    stages {

      stage('Check for updates') {
          steps {
              echo "Checking for updates.."
              sh'''
                #check local version
                ls

                cd flux-agro-cd-lab

                current_tag=$(grep 'tag:' values.yaml | awk '{print $2}')

                echo "Current image tag in values.yaml is: $current_tag"

                #check remote version
                REPO="radeczu/apitestapp"

                tags=$(curl -s "https://hub.docker.com/v2/repositories/${REPO}/tags/?page_size=100" | jq -r '.results[].name')

                latest_tag=$(echo "$tags" | grep -E '^[0-9]+\\.[0-9]+\\.[0-9]+(-[0-9]+)?$' | sort -V | tail -n 1)

                echo "Latest version tag: $latest_tag"
              '''
          }
      }

      stage('Update') {
        steps {
            echo "Updating.."
        }
      }

    }
}